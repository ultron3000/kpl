<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KPL Match Updater | Titans vs Strikers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#0d1117;color:#fff;margin:0;padding:0;}
.container{max-width:900px;margin:20px auto;padding:20px;background:#161b22;border-radius:8px;box-shadow:0 0 10px #0ff4;}
h1{text-align:center;color:#00d0ff;}
label{display:block;margin-top:10px;}
select,input,button{padding:8px;margin:5px 0;width:100%;border:none;border-radius:6px;font-size:15px;}
button{background:#00d0ff;color:#000;font-weight:bold;cursor:pointer;}
button:hover{background:#00b4cc;}
.flex{display:flex;gap:10px;flex-wrap:wrap;}
.flex > div{flex:1;min-width:200px;}
hr{border:1px solid #222;margin:15px 0;}
#status{margin-top:10px;color:#00ff99;font-weight:bold;}
</style>
</head>
<body>
<div class="container">
<h1>üèè KPL Match Updater</h1>

<div id="loginSection">
  <label>Enter Admin PIN:</label>
  <input type="password" id="pinInput" placeholder="Enter PIN">
  <button onclick="checkPin()">Login</button>
</div>

<div id="dashboard" style="display:none;">
  <h2 id="matchTitle"></h2>
  <div class="flex">
    <div>
      <label>Inning:</label>
      <select id="inningSelect"></select>
    </div>
    <div>
      <label>Striker:</label>
      <select id="strikerSelect"></select>
    </div>
    <div>
      <label>Non-Striker:</label>
      <select id="nonStrikerSelect"></select>
    </div>
    <div>
      <label>Bowler:</label>
      <select id="bowlerSelect"></select>
    </div>
  </div>

  <hr>
  <div class="flex">
    <div>
      <label>Ball Type:</label>
      <select id="ballType">
        <option value="normal">Normal</option>
        <option value="wide">Wide</option>
        <option value="noBall">No Ball</option>
        <option value="bye">Bye</option>
        <option value="legBye">Leg Bye</option>
      </select>
    </div>
    <div>
      <label>Runs:</label>
      <select id="runs">
        <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>6</option>
      </select>
    </div>
    <div>
      <label>Wicket:</label>
      <select id="wicket">
        <option value="none">No</option>
        <option value="bowled">Bowled</option>
        <option value="caught">Caught</option>
        <option value="lbw">LBW</option>
        <option value="runout">Run Out</option>
      </select>
    </div>
  </div>

  <button onclick="addBall()">‚ûï Add Ball</button>
  <button onclick="saveJSON()">üíæ Save JSON</button>
  <button onclick="pushToGitHub()">üöÄ Push to GitHub</button>

  <div id="status"></div>
  <hr>
  <pre id="jsonPreview" style="background:#0a0f16;padding:10px;border-radius:8px;max-height:400px;overflow:auto;"></pre>
</div>

<script>
const ADMIN_PIN = "4278";
let matchData = null;

function checkPin() {
  const pin = document.getElementById("pinInput").value;
  if (pin === ADMIN_PIN) {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    loadData();
  } else alert("‚ùå Incorrect PIN");
}

async function loadData() {
  try {
    const res = await fetch("data/match-1.json?_=" + Date.now());
    matchData = await res.json();
    document.getElementById("matchTitle").innerText = matchData.matchTitle;

    const inningSel = document.getElementById("inningSelect");
    inningSel.innerHTML = "";
    matchData.innings.forEach((inn, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.text = `Innings ${i + 1} - ${inn.team}`;
      inningSel.appendChild(opt);
    });
    refreshSelectors();
    preview();
  } catch (e) {
    alert("‚ö†Ô∏è Error loading JSON");
    console.error(e);
  }
}

function refreshSelectors() {
  const inning = matchData.innings[document.getElementById("inningSelect").value];
  const battingTeam = matchData.teams.teamA.name === inning.team ? matchData.teams.teamA : matchData.teams.teamB;
  const bowlingTeam = battingTeam === matchData.teams.teamA ? matchData.teams.teamB : matchData.teams.teamA;

  fillSelect("strikerSelect", battingTeam.players);
  fillSelect("nonStrikerSelect", battingTeam.players);
  fillSelect("bowlerSelect", bowlingTeam.players);
}

function fillSelect(id, players) {
  const sel = document.getElementById(id);
  sel.innerHTML = "";
  players.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.name;
    opt.text = `${p.name} (${p.role})`;
    sel.appendChild(opt);
  });
}

function addBall() {
  const innIndex = parseInt(document.getElementById("inningSelect").value);
  const inning = matchData.innings[innIndex];
  const striker = document.getElementById("strikerSelect").value;
  const bowler = document.getElementById("bowlerSelect").value;
  const runs = parseInt(document.getElementById("runs").value);
  const type = document.getElementById("ballType").value;
  const wicket = document.getElementById("wicket").value;

  const ball = { striker, bowler, runs, type, wicket, time: new Date().toLocaleTimeString() };
  inning.balls.push(ball);

  if (type === "wide" || type === "noBall") inning.totalRuns += runs + 1;
  else inning.totalRuns += runs;

  if (wicket !== "none") inning.wickets++;

  inning.overs = (inning.balls.length / 6).toFixed(1);
  preview();
}

function preview() {
  document.getElementById("jsonPreview").innerText = JSON.stringify(matchData, null, 2);
}

function saveJSON() {
  const blob = new Blob([JSON.stringify(matchData, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "match-1.json";
  a.click();
  URL.revokeObjectURL(a.href);
  document.getElementById("status").innerText = "‚úÖ JSON file downloaded. Upload to GitHub or push below.";
}

/* üîê GitHub Push Setup */
let githubUsername = localStorage.getItem("gh_user") || "";
let githubToken = localStorage.getItem("gh_token") || "";

async function pushToGitHub() {
  if (!githubUsername || !githubToken) {
    githubUsername = prompt("GitHub Username:");
    githubToken = prompt("GitHub Personal Access Token:");
    localStorage.setItem("gh_user", githubUsername);
    localStorage.setItem("gh_token", githubToken);
  }

  const repo = "ultron3000/kpl";
  const filePath = "data/match-1.json";
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(matchData, null, 2))));

  const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
    headers: { "Authorization": "token " + githubToken }
  });
  const json = await res.json();
  const sha = json.sha;

  const update = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
    method: "PUT",
    headers: {
      "Authorization": "token " + githubToken,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update live score",
      content: content,
      sha: sha
    })
  });

  if (update.ok) {
    document.getElementById("status").innerText = "‚úÖ Successfully pushed to GitHub!";
  } else {
    document.getElementById("status").innerText = "‚ùå Failed to push. Check token permissions.";
  }
}
</script>
</div>
</body>
</html>
