<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>KPL Admin Scorer</title>
<style>
  body{font-family:Inter,Arial,sans-serif;background:#f7fbff;color:#222;margin:0;padding:20px;}
  h1{color:#0b69ff;}
  .card{background:#fff;padding:20px;border-radius:10px;max-width:600px;margin:auto;box-shadow:0 4px 15px rgba(0,0,0,.1);}
  input,button{width:100%;padding:8px;margin-top:8px;border:1px solid #ccc;border-radius:6px;}
  button{background:#0b69ff;color:#fff;font-weight:700;cursor:pointer;}
  .ok{color:green;font-weight:700;}
  .err{color:red;font-weight:700;}
</style>
</head>
<body>
<h1>KPL Admin Scorer</h1>
<div class="card" id="login">
  <input id="pin" type="password" placeholder="Enter admin PIN (4278)">
  <button onclick="unlock()">Unlock</button>
  <div id="msg"></div>
</div>

<div class="card" id="main" style="display:none">
  <label>Runs</label><input id="runs">
  <label>Wickets</label><input id="wickets">
  <label>Overs</label><input id="overs">
  <button onclick="save()">Save & Push</button>
  <div id="status"></div>
</div>

<script>
const PIN="4278";
const REPO="ultron3000/kpl";
const BRANCH="main";
const MATCH_PATH="data/match-1.json";
const LIVE_PATH="data/live.json";

function unlock(){
  if(document.getElementById("pin").value===PIN){
    document.getElementById("login").style.display="none";
    document.getElementById("main").style.display="block";
  } else document.getElementById("msg").textContent="Wrong PIN";
}

async function save(){
  const runs=document.getElementById("runs").value||0;
  const wickets=document.getElementById("wickets").value||0;
  const overs=document.getElementById("overs").value||"0.0";

  const token=localStorage.getItem("ghToken")||prompt("GitHub Personal Access Token:");
  if(token) localStorage.setItem("ghToken",token);

  const dataRes=await fetch(MATCH_PATH+"?t="+Date.now());
  const match=await dataRes.json();
  match.innings[0].runs=parseInt(runs);
  match.innings[0].wickets=parseInt(wickets);
  match.innings[0].overs=overs;
  match.lastUpdated=new Date().toLocaleString();

  const liveRes=await fetch(LIVE_PATH+"?t="+Date.now());
  const live=await liveRes.json();
  live.innings[0].runs=parseInt(runs);
  live.innings[0].wickets=parseInt(wickets);
  live.innings[0].overs=overs;
  live.lastUpdated=new Date().toLocaleString();

  await pushFile(MATCH_PATH,match,token);
  await pushFile(LIVE_PATH,live,token);
}

async function pushFile(path,json,token){
  const api=`https://api.github.com/repos/${REPO}/contents/${path}`;
  const get=await fetch(api+`?ref=${BRANCH}`,{headers:{Authorization:`token ${token}`}});
  const info=await get.json();
  const body={
    message:`KPL update ${path}`,
    content:btoa(unescape(encodeURIComponent(JSON.stringify(json,null,2)))),
    sha:info.sha
  };
  const put=await fetch(api,{method:"PUT",headers:{Authorization:`token ${token}`,"Content-Type":"application/json"},body:JSON.stringify(body)});
  document.getElementById("status").innerHTML=put.ok?'<span class="ok">✅ Updated '+path+'</span>':'<span class="err">❌ Error '+path+'</span>';
}
</script>
</body>
</html>
