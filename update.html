<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KPL Match Update Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #38bdf8;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px #0005;
    }
    select, input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 6px;
      font-size: 15px;
    }
    button {
      background: #38bdf8;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #0ea5e9;
    }
    .over-summary {
      background: #0ea5e933;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 10px;
    }
    .score-preview {
      text-align: center;
      font-size: 22px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h1>üèè KPL Live Score Dashboard</h1>
  <div class="container">
    <div class="card">
      <h2>Match Setup</h2>
      <p id="matchTitle"></p>
      <p><b>Innings:</b> <span id="inningsTeam"></span></p>
      <select id="striker"></select>
      <select id="nonStriker"></select>
      <select id="bowler"></select>
      <select id="ballType">
        <option value="normal">Normal</option>
        <option value="wide">Wide</option>
        <option value="no-ball">No Ball</option>
        <option value="bye">Bye</option>
        <option value="leg-bye">Leg Bye</option>
        <option value="wicket">Wicket</option>
      </select>
      <input type="number" id="runs" placeholder="Runs on this ball" min="0" max="7" />
      <button id="addBall">Add Ball</button>
      <button id="changeInnings">Change Innings</button>
      <button id="pushGitHub">Push to GitHub</button>

      <div class="score-preview" id="scorePreview"></div>
      <div class="over-summary" id="overSummary"></div>
    </div>

    <div class="card">
      <h2>Live JSON Preview</h2>
      <pre id="jsonPreview" style="white-space: pre-wrap; font-size: 13px; background:#0004; padding:10px; border-radius:10px;"></pre>
    </div>
  </div>

  <script>
    const jsonUrl = 'data/match-1.json';
    let matchData = null;

    async function loadData() {
      const res = await fetch(jsonUrl + '?t=' + Date.now());
      matchData = await res.json();
      document.getElementById('matchTitle').textContent = matchData.match.title;
      const inning = matchData.match.currentInnings;
      document.getElementById('inningsTeam').textContent = matchData.innings[inning - 1].team;
      const teamPlayers = matchData.teams[
        inning === 1 ? 'teamA' : 'teamB'
      ].players;
      const opponentPlayers = matchData.teams[
        inning === 1 ? 'teamB' : 'teamA'
      ].players;

      populateDropdown('striker', teamPlayers);
      populateDropdown('nonStriker', teamPlayers);
      populateDropdown('bowler', opponentPlayers);
      refreshPreview();
    }

    function populateDropdown(id, players) {
      const sel = document.getElementById(id);
      sel.innerHTML = '';
      players.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      });
    }

    document.getElementById('addBall').addEventListener('click', () => {
      const inning = matchData.match.currentInnings - 1;
      const type = document.getElementById('ballType').value;
      const runs = parseInt(document.getElementById('runs').value || 0);
      const striker = document.getElementById('striker').value;
      const bowler = document.getElementById('bowler').value;

      const ball = {
        striker,
        bowler,
        runs,
        type,
        timestamp: new Date().toISOString()
      };

      const inningsData = matchData.innings[inning];
      inningsData.balls.push(ball);

      if (type === 'wicket') {
        inningsData.wickets += 1;
        inningsData.fallOfWickets.push({
          batsman: striker,
          bowler,
          over: inningsData.balls.length / 6
        });
      }

      let totalRuns = inningsData.runs;
      if (type === 'wide' || type === 'no-ball' || type === 'bye' || type === 'leg-bye') {
        totalRuns += runs + 1;
      } else {
        totalRuns += runs;
      }
      inningsData.runs = totalRuns;
      inningsData.overs = Math.floor(inningsData.balls.length / 6);

      matchData.lastUpdated = new Date().toISOString();
      refreshPreview();
    });

    document.getElementById('changeInnings').addEventListener('click', () => {
      matchData.match.currentInnings = matchData.match.currentInnings === 1 ? 2 : 1;
      loadData();
    });

    function refreshPreview() {
      document.getElementById('jsonPreview').textContent = JSON.stringify(matchData, null, 2);
      const inning = matchData.match.currentInnings - 1;
      const i = matchData.innings[inning];
      document.getElementById('scorePreview').textContent = `${i.team}: ${i.runs}/${i.wickets} in ${i.overs} overs`;

      const balls = i.balls.slice(-6);
      document.getElementById('overSummary').innerHTML = `<b>Last over:</b> ${balls.map(b => b.type === 'wicket' ? 'W' : b.runs).join(' | ')}`;
    }

    // GitHub push automation
    document.getElementById('pushGitHub').addEventListener('click', async () => {
      const username = localStorage.getItem('gh_user') || prompt('GitHub Username:');
      const token = localStorage.getItem('gh_token') || prompt('GitHub Personal Access Token:');
      localStorage.setItem('gh_user', username);
      localStorage.setItem('gh_token', token);

      const repo = 'ultron3000/kpl';
      const path = 'data/match-1.json';
      const apiUrl = `https://api.github.com/repos/${repo}/contents/${path}`;

      const getRes = await fetch(apiUrl);
      const getData = await getRes.json();
      const sha = getData.sha;

      await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          Authorization: `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'Update live match data',
          content: btoa(unescape(encodeURIComponent(JSON.stringify(matchData, null, 2)))),
          sha
        })
      });

      alert('‚úÖ Match data pushed to GitHub successfully!');
    });

    loadData();
  </script>
</body>
</html>
