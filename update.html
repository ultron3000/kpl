<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KPL Live Scorer (Protected)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {font-family:Poppins,sans-serif;background:#f5f5f5;padding:20px;max-width:900px;margin:auto;}
.card{background:white;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:15px;}
h1{text-align:center;}
button{background:#007bff;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;margin:2px;}
button:hover{background:#0056b3;}
input{padding:8px;border:1px solid #ccc;border-radius:5px;width:100%;margin:5px 0;}
#msg{font-weight:600;text-align:center;}
.success{color:green;} .error{color:red;}
</style>
</head>
<body>

<h1>üèè KPL Live Scorer</h1>

<!-- LOGIN -->
<div id="loginBox" class="card">
  <h3>üîê Enter PIN</h3>
  <input type="password" id="pin" placeholder="Enter Admin PIN">
  <button onclick="checkPin()">Login</button>
  <p id="loginMsg"></p>
</div>

<!-- SCORER PANEL -->
<div id="scorer" style="display:none;">
  <div class="card">
    <h3>‚öôÔ∏è GitHub Setup</h3>
    <input id="username" placeholder="GitHub Username (e.g. ultron3000)">
    <input id="token" type="password" placeholder="GitHub Token (starts with ghp_)">
  </div>

  <div class="card">
    <h3>üèÜ Select Match</h3>
    <select id="matchFile">
      <option value="match-1.json">Match 1: Titans vs Strikers</option>
      <option value="match-2.json">Match 2: Warriors vs Challengers</option>
    </select>
    <input id="teamA" placeholder="Team A Name">
    <input id="teamB" placeholder="Team B Name">
    <select id="battingTeam">
      <option value="A">Team A Batting</option>
      <option value="B">Team B Batting</option>
    </select>
  </div>

  <div class="card">
    <h3>üéØ Live Scoring</h3>
    <p id="liveScore">0/0 (0.0)</p>
    <div>
      <button onclick="addRun(0)">0</button>
      <button onclick="addRun(1)">1</button>
      <button onclick="addRun(2)">2</button>
      <button onclick="addRun(3)">3</button>
      <button onclick="addRun(4)">4</button>
      <button onclick="addRun(6)">6</button>
      <button style="background:#dc3545" onclick="addWicket()">Wicket</button>
    </div>
    <p>Current Over: <span id="balls">0</span> balls</p>
  </div>

  <div class="card">
    <input id="venue" placeholder="Venue">
    <input id="status" placeholder="Status (LIVE / Completed)">
    <button onclick="updateGitHub()">üíæ Save to GitHub</button>
    <p id="msg"></p>
  </div>
</div>

<script>
const PIN = "4278"; // admin pin
let matchData = {
  teamA: { name:"", score:0, wickets:0, overs:0, balls:0 },
  teamB: { name:"", score:0, wickets:0, overs:0, balls:0 },
  venue:"", status:"", lastUpdated:""
};

function checkPin(){
  const val=document.getElementById("pin").value;
  if(val===PIN){document.getElementById("loginBox").style.display="none";
    document.getElementById("scorer").style.display="block";}
  else document.getElementById("loginMsg").innerHTML='<span class="error">‚ùå Wrong PIN!</span>';
}

function getBatting(){
  return document.getElementById("battingTeam").value==="A"?"teamA":"teamB";
}

function addRun(runs){
  let team=getBatting();
  matchData[team].score+=runs;
  addBall();
}

function addWicket(){
  let team=getBatting();
  matchData[team].wickets+=1;
  addBall();
}

function addBall(){
  let team=getBatting();
  matchData[team].balls+=1;
  if(matchData[team].balls===6){
    matchData[team].overs+=1;
    matchData[team].balls=0;
  }
  updateDisplay();
}

function updateDisplay(){
  const team=getBatting();
  const t=matchData[team];
  const ballsDisplay=`${t.overs}.${t.balls}`;
  document.getElementById("liveScore").innerText=`${t.score}/${t.wickets} (${ballsDisplay})`;
  document.getElementById("balls").innerText=t.balls;
}

async function updateGitHub(){
  matchData.teamA.name=document.getElementById("teamA").value;
  matchData.teamB.name=document.getElementById("teamB").value;
  matchData.venue=document.getElementById("venue").value;
  matchData.status=document.getElementById("status").value;
  matchData.lastUpdated=new Date().toLocaleString();

  const jsonStr=JSON.stringify(matchData,null,2);
  const user=document.getElementById("username").value.trim();
  const token=document.getElementById("token").value.trim();
  const file=document.getElementById("matchFile").value;
  const apiURL=`https://api.github.com/repos/${user}/kpl/contents/data/${file}`;

  try{
    const getRes=await fetch(apiURL,{headers:{Authorization:`token ${token}`}});
    const getData=await getRes.json();
    const sha=getData.sha;

    const putBody={
      message:`Update ${file}`,
      content:btoa(unescape(encodeURIComponent(jsonStr))),
      sha
    };

    const putRes=await fetch(apiURL,{
      method:"PUT",
      headers:{Authorization:`token ${token}`,"Content-Type":"application/json"},
      body:JSON.stringify(putBody)
    });

    if(putRes.ok) document.getElementById("msg").innerHTML='<span class="success">‚úÖ Score saved!</span>';
    else{
      const err=await putRes.json();
      document.getElementById("msg").innerHTML=`<span class="error">${err.message}</span>`;
    }
  }catch(err){
    document.getElementById("msg").innerHTML=`<span class="error">${err.message}</span>`;
  }
}
</script>
</body>
</html>
