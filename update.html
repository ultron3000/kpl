<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KPL Admin Scorer ‚Äî Auto-push & Dual Innings</title>
<style>
  body{font-family:Inter,Arial,sans-serif;background:#f8fbff;margin:0;padding:20px;color:#07203b}
  h1{color:#0b69ff}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(18,38,63,0.06)}
  label{display:block;font-weight:600;margin-top:8px;color:#073047}
  select,input,button,textarea{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #e6f0f8;box-sizing:border-box}
  button{cursor:pointer;background:#0b69ff;color:white;border:0;font-weight:700}
  .actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .runsBtn{background:#0b69ff;color:white;padding:8px 12px;border-radius:6px;border:0;font-weight:700}
  .extraBtn{background:#f59e0b;border:0;color:#07122a;padding:8px 12px;border-radius:6px}
  .wktBtn{background:#ef4444;border:0;color:white;padding:8px 12px;border-radius:6px}
  pre{background:#0b1220;color:#dff3c6;padding:10px;border-radius:8px;overflow:auto;max-height:340px}
  table{width:100%;border-collapse:collapse;margin-top:6px}
  th,td{border-bottom:1px solid #e2e8f0;padding:6px;text-align:left}
  th{color:#0b69ff}
</style>
</head>
<body>
<h1>üèè KPL Admin Scorer (Auto-push every over)</h1>

<div class="card" id="loginCard">
  <label>Admin PIN</label>
  <input id="pin" type="password" placeholder="Enter PIN (4278)"/>
  <div style="display:flex;gap:8px;margin-top:8px">
    <button onclick="unlock()">Unlock</button>
    <button onclick="clearCreds()">Reset GitHub credentials</button>
  </div>
  <div id="loginMsg" style="color:#555;font-size:14px;margin-top:6px"></div>
</div>

<div id="main" style="display:none">
  <div class="grid">
    <div class="card">
      <h2 id="matchTitle">Titans vs Strikers</h2>
      <div style="display:flex;gap:10px">
        <div style="flex:1"><label>Innings</label><select id="inningSelect"><option value="0">Titans (1st)</option><option value="1">Strikers (2nd)</option></select></div>
        <div style="flex:1"><label>Auto-push every over</label><select id="autoPush"><option value="1">Enabled</option><option value="0">Disabled</option></select></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:8px">
        <div style="flex:1"><label>Striker</label><select id="striker"></select></div>
        <div style="flex:1"><label>Non-Striker</label><select id="nonStriker"></select></div>
        <div style="flex:1"><label>Bowler</label><select id="bowler"></select></div>
      </div>

      <label style="margin-top:10px">Ball Input</label>
      <div class="actions">
        <button class="runsBtn" onclick="addBall(0)">0</button>
        <button class="runsBtn" onclick="addBall(1)">1</button>
        <button class="runsBtn" onclick="addBall(2)">2</button>
        <button class="runsBtn" onclick="addBall(3)">3</button>
        <button class="runsBtn" onclick="addBall(4)">4</button>
        <button class="runsBtn" onclick="addBall(6)">6</button>
        <button class="extraBtn" onclick="addExtra('wide')">Wide</button>
        <button class="extraBtn" onclick="addExtra('noball')">No-Ball</button>
        <button class="extraBtn" onclick="addExtra('bye')">Bye</button>
        <button class="extraBtn" onclick="addExtra('legbye')">Leg-Bye</button>
        <button class="wktBtn" onclick="addWicket()">Wicket</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button onclick="manualPush()">üíæ Save & Push Now</button>
      </div>
      <div id="status" style="margin-top:8px;color:#666;font-size:14px"></div>
    </div>

    <div class="card">
      <h3>Live Snapshot</h3>
      <pre id="jsonPreview">Waiting for data...</pre>
    </div>
  </div>
</div>

<script>
let match = null;
let ghUser='', ghToken='';
const PIN='4278';
async function unlock(){
  const val=document.getElementById('pin').value;
  if(val!==PIN){document.getElementById('loginMsg').innerText='‚ùå Wrong PIN';return;}
  document.getElementById('loginCard').style.display='none';
  document.getElementById('main').style.display='block';
  ghUser=localStorage.getItem('gh_user')||prompt('GitHub username:');
  ghToken=localStorage.getItem('gh_token')||prompt('GitHub token (repo/public_repo scope):');
  localStorage.setItem('gh_user',ghUser);localStorage.setItem('gh_token',ghToken);
  loadMatch();
}
function clearCreds(){localStorage.removeItem('gh_user');localStorage.removeItem('gh_token');alert('Cleared!');}
async function loadMatch(){
  const r=await fetch('data/match-1.json');match=await r.json();
  populatePlayers();
  renderPreview();
}
function populatePlayers(){
  const inn0=match.innings[0],inn1=match.innings[1];
  const s=document.getElementById('striker'),ns=document.getElementById('nonStriker'),b=document.getElementById('bowler');
  const cur=match.innings[document.getElementById('inningSelect').value];
  s.innerHTML=cur.battingOrder.map(p=>`<option>${p.name}</option>`).join('');
  ns.innerHTML=s.innerHTML;
  b.innerHTML=cur.bowlers.map(p=>`<option>${p.name}</option>`).join('');
}
function addBall(runs){
  const iSel=document.getElementById('inningSelect').value|0;
  const inn=match.innings[iSel];
  const striker=document.getElementById('striker').value,bowler=document.getElementById('bowler').value;
  inn.total+=runs;inn.balls++;
  const over=Math.floor(inn.balls/6)+inn.overs;
  const ballInOver=(inn.balls%6)||6;
  const ev={over,ballInOver,batsman:striker,bowler,eventType:'run',runs,summary:`${striker} ${runs}`};
  inn.ballsDetailed.push(ev);
  updateBatsman(inn,striker,runs);
  if(inn.balls%6===0){inn.overs++;inn.balls=0;autoPushIfNeeded();}
  renderPreview();
}
function addExtra(type){
  const iSel=document.getElementById('inningSelect').value|0;
  const inn=match.innings[iSel];
  const bowler=document.getElementById('bowler').value;
  inn.extras[type+'s']++;inn.extras.total++;
  inn.total++;
  const ev={over:inn.overs,ballInOver:inn.balls+1,batsman:'-',bowler,eventType:'extra',extraType:type,runs:1,summary:`${type}`};
  inn.ballsDetailed.push(ev);
  renderPreview();
}
function addWicket(){
  const iSel=document.getElementById('inningSelect').value|0;
  const inn=match.innings[iSel];
  const striker=document.getElementById('striker').value,bowler=document.getElementById('bowler').value;
  inn.wickets++;
  const over=inn.overs,ballInOver=inn.balls+1;
  inn.fallOfWickets.push({batsman:striker,score:inn.total,over:`${over}.${ballInOver}`});
  inn.balls++;
  const ev={over,ballInOver,batsman:striker,bowler,eventType:'wicket',summary:`Wicket: ${striker}`};
  inn.ballsDetailed.push(ev);
  if(inn.balls%6===0){inn.overs++;inn.balls=0;autoPushIfNeeded();}
  renderPreview();
}
function updateBatsman(inn,name,r){
  const b=inn.battingOrder.find(x=>x.name===name);
  if(b){b.runs+=r;b.balls++;}
}
function renderPreview(){document.getElementById('jsonPreview').innerText=JSON.stringify(match,null,2);}
async function manualPush(){await pushAll();alert('Pushed manually ‚úÖ');}
async function autoPushIfNeeded(){
  if(document.getElementById('autoPush').value!=='1')return;
  await pushAll(true);
}
async function pushAll(auto=false){
  const repo='ultron3000/kpl',branch='main';
  const paths=['data/match-1.json','data/live.json'];
  const live={match:match.title,venue:match.venue,status:match.status,currentInnings:match.currentInnings,
    innings:match.innings.map(i=>({team:i.team,runs:i.total,wickets:i.wickets,overs:`${i.overs}.${i.balls}`,runRate:(i.total/((i.overs||0)+(i.balls/6||0)||1)).toFixed(2)})),
    target:match.matchMeta.target,lastUpdated:new Date().toLocaleString()};
  await uploadFile(repo,branch,'data/match-1.json',JSON.stringify(match,null,2));
  await uploadFile(repo,branch,'data/live.json',JSON.stringify(live,null,2));
  document.getElementById('status').innerText=auto?'‚úÖ Auto-pushed after over':'‚úÖ Manually pushed';
}
async function uploadFile(repo,branch,path,content){
  const r=await fetch(`https://api.github.com/repos/${repo}/contents/${path}`,{
    method:'GET',headers:{Authorization:`token ${ghToken}`}});
  const js=await r.json();const sha=js.sha;
  const body={message:`update ${path}`,content:btoa(unescape(encodeURIComponent(content))),branch,sha};
  await fetch(`https://api.github.com/repos/${repo}/contents/${path}`,{
    method:'PUT',headers:{Authorization:`token ${ghToken}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
}
</script>
</body>
</html>
