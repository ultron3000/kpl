<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KPL ‚Äî Advanced Ball-by-Ball Scorer</title>
<style>
  :root{--bg:#f1f7fb;--card:#ffffff;--accent:#0b69ff;--muted:#6b7280}
  body{font-family:Inter, Arial, sans-serif;background:var(--bg);padding:18px;color:#07203b}
  h1{margin:0 0 12px;color:var(--accent)}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(18,38,63,0.06)}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  label{display:block;font-weight:600;margin-top:8px;color:#073047}
  select,input,button,textarea{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #e6f0f8;box-sizing:border-box}
  button{cursor:pointer;background:var(--accent);color:white;border:0;font-weight:700}
  button.secondary{background:#06b6d4}
  .actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .runsBtn{background:#0b69ff;color:white;padding:8px 12px;border-radius:6px;border:0;font-weight:700}
  .extraBtn{background:#f59e0b;border:0;color:#07122a;padding:8px 12px;border-radius:6px}
  .wktBtn{background:#ef4444;border:0;color:white;padding:8px 12px;border-radius:6px}
  pre{background:#0b1220;color:#dff3c6;padding:10px;border-radius:8px;overflow:auto;max-height:360px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:6px;border-bottom:1px solid #eef2ff;text-align:left;font-size:13px}
  .ok{color:green;font-weight:700}
  .err{color:red;font-weight:700}
  .muted{color:var(--muted)}
  .hint{font-size:13px;color:#4b5563}
  .small{font-size:13px;color:#294859}
</style>
</head>
<body>
  <h1>üèè KPL ‚Äî Advanced Ball-by-Ball Scorer (match-1)</h1>

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <label>Admin PIN</label>
    <input id="pin" type="password" placeholder="Enter admin PIN (4278)" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button onclick="unlock()">Unlock</button>
      <button class="secondary" onclick="clearStoredCreds()">Reset GitHub creds</button>
    </div>
    <div id="loginMsg" class="muted"></div>
  </div>

  <!-- MAIN -->
  <div id="main" style="display:none">
    <div class="grid">
      <!-- LEFT: Controls -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Match file</div>
            <h2 id="matchTitle">Loading‚Ä¶</h2>
          </div>
          <div style="text-align:right">
            <div class="small">Status</div>
            <div id="matchStatus" class="muted">‚Äî</div>
            <div class="hint" style="margin-top:6px">Last saved: <span id="lastSaved">‚Äî</span></div>
          </div>
        </div>

        <hr>

        <div style="display:flex;gap:8px;">
          <div style="flex:1">
            <label>Innings</label>
            <select id="inningSelect"><option value="0">Innings 1 (Team A)</option><option value="1">Innings 2 (Team B)</option></select>
          </div>
          <div style="width:180px">
            <label>Auto-push</label>
            <select id="autoPushSelect">
              <option value="1">Enabled (push each ball)</option>
              <option value="0">Disabled (manual)</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <label>Striker</label>
            <select id="strikerSelect"></select>
          </div>
          <div style="flex:1">
            <label>Non-Striker</label>
            <select id="nonStrikerSelect"></select>
          </div>
          <div style="flex:1">
            <label>Bowler</label>
            <select id="bowlerSelect"></select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Ball input ‚Äî click the event</label>
          <div class="actions">
            <button class="runsBtn" onclick="onRun(0)">0</button>
            <button class="runsBtn" onclick="onRun(1)">1</button>
            <button class="runsBtn" onclick="onRun(2)">2</button>
            <button class="runsBtn" onclick="onRun(3)">3</button>
            <button class="runsBtn" onclick="onRun(4)">4</button>
            <button class="runsBtn" onclick="onRun(6)">6</button>

            <button class="extraBtn" onclick="onExtra('wide')">Wide</button>
            <button class="extraBtn" onclick="onExtra('noball')">No-ball</button>
            <button class="extraBtn" onclick="onExtra('bye')">Bye</button>
            <button class="extraBtn" onclick="onExtra('legbye')">Leg-bye</button>

            <button class="wktBtn" onclick="onWicket()">Wicket</button>
          </div>
          <div class="muted" style="margin-top:6px">Wides/No-balls: <b>not legal</b> (do not increment ball). Bye/Leg-bye: legal.</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button onclick="previewLocal()">Preview & Download match-1.json</button>
          <button onclick="pushToGitHub()">Save & Push to GitHub (manual)</button>
          <button class="secondary" onclick="toggleResetToSkeleton()">Reset local match</button>
        </div>

        <div id="statusMsg" class="muted" style="margin-top:8px"></div>
      </div>

      <!-- RIGHT: Display -->
      <div class="card">
        <h3>Match Snapshot</h3>
        <div class="muted">Teams & squads</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1"><label>Team A</label><pre id="teamAList" class="muted"></pre></div>
          <div style="flex:1"><label>Team B</label><pre id="teamBList" class="muted"></pre></div>
        </div>

        <hr>

        <div>
          <label>Batting order (current inning)</label>
          <table id="batTable"><thead><tr><th>Player</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>Status</th></tr></thead><tbody></tbody></table>
        </div>

        <div style="margin-top:8px">
          <label>Bowling figures (current inning)</label>
          <table id="bowlTable"><thead><tr><th>Bowler</th><th>O</th><th>R</th><th>W</th></tr></thead><tbody></tbody></table>
        </div>

        <div style="margin-top:8px">
          <label>Current over (recent balls)</label>
          <pre id="currentOver">‚Äî</pre>
        </div>

        <div style="margin-top:8px">
          <label>Overs summary (completed)</label>
          <pre id="oversSummary">‚Äî</pre>
        </div>

        <div style="margin-top:8px">
          <label>Ball-by-ball (current inning)</label>
          <pre id="ballsDetailed">‚Äî</pre>
        </div>

        <div style="margin-top:8px">
          <label>Raw match-1.json preview</label>
          <pre id="jsonPreview">‚Äî</pre>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const ADMIN_PIN = '4278';
const REPO_OWNER_DEFAULT = 'ultron3000';
const REPO = 'kpl';
const BRANCH = 'main';
const MATCH_PATH = 'data/match-1.json';
const LIVE_PATH = 'data/live.json';

/* ================== STATE ================== */
let matchJson = null;
let freeHit = false;

/* ================== UTIL ================== */
const $ = id => document.getElementById(id);
function status(msg, ok=true){ $('statusMsg').innerHTML = ok ? `<span class="ok">${msg}</span>` : `<span class="err">${msg}</span>`; }
function log(...a){ console.log(...a); }

/* ================== GITHUB CREDENTIALS (localStorage) ================== */
function saveCreds(user, token){
  localStorage.setItem('kpl_gh_user', user);
  localStorage.setItem('kpl_gh_token', token);
}
function getCreds(){ return { user: localStorage.getItem('kpl_gh_user')||'', token: localStorage.getItem('kpl_gh_token')||''}; }
function clearStoredCreds(){ localStorage.removeItem('kpl_gh_user'); localStorage.removeItem('kpl_gh_token'); alert('GitHub creds cleared'); }

/* ================== SKELETON (dummy players) ================== */
function createSkeleton(){
  return {
    title: "Titans vs Strikers",
    venue: "KPL Arena 1",
    status: "LIVE",
    toss: "Titans won the toss and chose to bat first",
    currentInnings: 0,
    matchMeta: { oversPerInnings:20, target:150 },
    innings: [
      {
        team: "Titans",
        total: 0,
        wickets: 0,
        overs: 0,
        balls: 0,
        extras: { wides:0, noballs:0, byes:0, legbyes:0, total:0 },
        ballsDetailed: [],
        battingOrder: [
          {name:"R. Sharma", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"V. Kohli", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"S. Iyer", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"S. Yadav", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"H. Pandya", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"R. Jadeja", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"D. Karthik", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"R. Ashwin", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"B. Kumar", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"M. Shami", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"J. Bumrah", runs:0, balls:0, fours:0, sixes:0, status:"not out"}
        ],
        bowlers: [
          {name:"A. Khan", overs:0, balls:0, runs:0, wickets:0},
          {name:"R. Patel", overs:0, balls:0, runs:0, wickets:0},
          {name:"N. Yadav", overs:0, balls:0, runs:0, wickets:0}
        ],
        oversSummary: [],
        fallOfWickets: []
      },
      {
        team: "Strikers",
        total: 0,
        wickets: 0,
        overs: 0,
        balls: 0,
        extras: { wides:0, noballs:0, byes:0, legbyes:0, total:0 },
        ballsDetailed: [],
        battingOrder: [
          {name:"P. Shaw", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"S. Dhawan", runs:0, balls:0, fours:0, sixes:0, status:"not out"},
          {name:"A. Russell", runs:0, balls:0, fours:0, sixes:0, status:"not out"}
        ],
        bowlers: [
          {name:"B. Kumar", overs:0, balls:0, runs:0, wickets:0}
        ],
        oversSummary: [],
        fallOfWickets: []
      }
    ],
    current: { striker:null, nonStriker:null, currentBowler:null, currentOverBalls:[], isFreeHit:false },
    lastSaved: null
  };
}

/* ================== BOOT / LOAD ================== */
async function unlock(){
  const pin = $('pin').value.trim();
  if(pin !== ADMIN_PIN){ $('loginMsg').innerText = 'Wrong PIN'; return; }
  $('loginCard').style.display = 'none';
  $('main').style.display = 'block';
  await loadMatchFile();
}

/* load match-1.json from repo raw (owner from saved creds or default), or fallback to local /data/match-1.json, else skeleton */
async function loadMatchFile(){
  const creds = getCreds();
  const owner = creds.user || REPO_OWNER_DEFAULT;
  const rawUrl = `https://raw.githubusercontent.com/${owner}/${REPO}/${BRANCH}/${MATCH_PATH}?t=${Date.now()}`;
  try{
    const res = await fetch(rawUrl);
    if(!res.ok) throw new Error('not found in raw');
    matchJson = await res.json();
    normalize();
    renderAll();
    status('Loaded match file from repo', true);
    return;
  }catch(e){
    // fallback to relative /data/match-1.json (GH Pages)
    try{
      const res2 = await fetch(`./${MATCH_PATH}?t=${Date.now()}`);
      if(res2.ok){
        matchJson = await res2.json();
        normalize();
        renderAll();
        status('Loaded local data/match-1.json', true);
        return;
      }
    }catch(e2){}
  }
  // last fallback: skeleton
  matchJson = createSkeleton();
  matchJson.title = "Titans vs Strikers";
  matchJson.lastSaved = null;
  normalize();
  renderAll();
  status('Initialized local skeleton. Use Save & Push to create files on GitHub.', false);
}

/* ensure fields exist */
function normalize(){
  if(!matchJson) matchJson = createSkeleton();
  matchJson.title = matchJson.title || matchJson.match || "Titans vs Strikers";
  matchJson.status = matchJson.status || 'LIVE';
  matchJson.matchMeta = matchJson.matchMeta || {oversPerInnings:20, target:150};
  matchJson.innings = matchJson.innings || createSkeleton().innings;
  matchJson.innings.forEach((inn, idx)=>{
    inn.battingOrder = inn.battingOrder || createSkeleton().innings[idx].battingOrder;
    inn.bowlers = inn.bowlers || createSkeleton().innings[idx].bowlers;
    inn.ballsDetailed = inn.ballsDetailed || [];
    inn.oversSummary = inn.oversSummary || [];
    inn.fallOfWickets = inn.fallOfWickets || [];
    inn.total = ('total' in inn) ? inn.total : (inn.runs || 0);
    inn.wickets = inn.wickets || 0;
    inn.overs = ('overs' in inn) ? inn.overs : 0;
    inn.balls = inn.balls || 0;
    inn.extras = inn.extras || {wides:0,noballs:0,byes:0,legbyes:0,total:0};
  });
  matchJson.current = matchJson.current || { striker:null, nonStriker:null, currentBowler:null, currentOverBalls:[], isFreeHit:false };
}

/* ================== RENDER UI ================== */
function renderAll(){
  if(!matchJson) return;
  $('matchTitle').innerText = matchJson.title;
  $('matchStatus').innerText = matchJson.status || '‚Äî';
  $('lastSaved').innerText = matchJson.lastSaved || '-';

  const inningIndex = Number($('inningSelect').value || matchJson.currentInnings || 0);
  const inning = matchJson.innings[inningIndex];

  // teams lists
  $('teamAList').innerText = matchJson.innings[0].battingOrder.map((p,i)=>`${i+1}. ${p.name} ‚Äî ${p.status||''}`).join('\n');
  $('teamBList').innerText = matchJson.innings[1].battingOrder.map((p,i)=>`${i+1}. ${p.name} ‚Äî ${p.status||''}`).join('\n');

  // populate selects
  populateSelect($('strikerSelect'), inning.battingOrder.map(p=>p.name), matchJson.current.striker);
  populateSelect($('nonStrikerSelect'), inning.battingOrder.map(p=>p.name), matchJson.current.nonStriker);
  populateSelect($('bowlerSelect'), (matchJson.innings[(inningIndex===0?1:0)].battingOrder.map(p=>p.name)).concat(inning.bowlers.map(b=>b.name)), matchJson.current.currentBowler);

  // scoreboard tables
  const tbody = $('batTable').querySelector('tbody'); tbody.innerHTML = '';
  inning.battingOrder.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${p.runs||0}</td><td>${p.balls||0}</td><td>${p.fours||0}</td><td>${p.sixes||0}</td><td>${p.status||''}</td>`;
    tbody.appendChild(tr);
  });

  const btbody = $('bowlTable').querySelector('tbody'); btbody.innerHTML = '';
  inning.bowlers.forEach(b=>{
    const oversStr = (b.overs||0) + (b.balls?'.'+b.balls:'');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(b.name)}</td><td>${oversStr}</td><td>${b.runs||0}</td><td>${b.wickets||0}</td>`;
    btbody.appendChild(tr);
  });

  // current over & summary
  $('currentOver').innerText = (matchJson.current.currentOverBalls && matchJson.current.currentOverBalls.length) ? matchJson.current.currentOverBalls.join(' | ') : '‚Äî';
  $('oversSummary').innerText = inning.oversSummary.length ? inning.oversSummary.map(o=>`Over ${o.over}: ${o.balls.join(' ')} ‚Äî ${o.bowler}`).join('\n') : '‚Äî';
  $('ballsDetailed').innerText = inning.ballsDetailed.length ? inning.ballsDetailed.map((b,i)=>`${i+1}. O${b.over}.${b.ballInOver} ${b.summary}`).join('\n') : '‚Äî';
  $('jsonPreview').innerText = JSON.stringify(matchJson, null, 2);
}

/* populate select helper */
function populateSelect(sel, list, selected){
  sel.innerHTML = '';
  (list||[]).forEach(item=>{
    const opt = document.createElement('option');
    opt.value = item;
    opt.textContent = item;
    if(selected && selected === item) opt.selected = true;
    sel.appendChild(opt);
  });
}

/* escape */
function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ================== CORE: Ball Events ================== */

function onRun(runs){
  ensureState();
  const inning = currentInning();
  const striker = $('strikerSelect').value;
  const bowler = $('bowlerSelect').value;
  const ballObj = createBallObject(inning, striker, bowler, {type:'run', runs});
  applyBall(inning, ballObj, {legal:true});
  afterEventAutoPush();
}

function onExtra(type){
  ensureState();
  const inning = currentInning();
  const striker = $('strikerSelect').value;
  const bowler = $('bowlerSelect').value;
  let runs = 1;
  if(type === 'wide' || type === 'noball'){
    const r = prompt('Total runs for this delivery (including penalty). Press Enter for 1:');
    if(r === null) return;
    runs = parseInt(r) || 1;
  } else {
    const r = prompt('Runs taken as bye/leg-bye (0 if none):');
    if(r === null) return;
    runs = parseInt(r) || 0;
  }
  const ballObj = createBallObject(inning, striker, bowler, {type:'extra', extraType:type, runs});
  const legal = (type === 'bye' || type === 'legbye');
  if(type === 'noball') { matchJson.current.isFreeHit = true; freeHit = true; }
  applyBall(inning, ballObj, {legal});
  afterEventAutoPush();
}

function onWicket(){
  ensureState();
  const inning = currentInning();
  const striker = $('strikerSelect').value;
  const bowler = $('bowlerSelect').value;
  const how = prompt('Wicket type (bowled, caught, run out, lbw, stumped):') || 'bowled';
  const fielder = (how.toLowerCase()==='caught' || how.toLowerCase()==='run out' || how.toLowerCase()==='stumped') ? (prompt('Fielder (if any):')||null) : null;
  const newBatsman = prompt('New batsman name (leave blank if none):') || null;
  const ballObj = createBallObject(inning, striker, bowler, {type:'wicket', how, outPlayer:striker, fielder, newBatsman});
  applyBall(inning, ballObj, {legal:true, wicketInfo:{outPlayer: striker, how, fielder, newBatsman}});
  afterEventAutoPush();
}

/* create ball object */
function createBallObject(inn, batsman, bowler, meta){
  const ballInOver = (inn.balls % 6) + 1;
  const overNumber = inn.overs;
  let summary = '';
  if(meta.type === 'run') summary = `${batsman} ${meta.runs}`;
  else if(meta.type === 'extra') summary = `${meta.extraType.toUpperCase()} +${meta.runs}`;
  else if(meta.type === 'wicket') summary = `Wicket - ${meta.how} - ${meta.outPlayer}`;
  return {
    over: overNumber,
    ballInOver,
    batsman,
    bowler,
    eventType: meta.type,
    runs: meta.runs || 0,
    extraType: meta.extraType || null,
    wicket: meta.type === 'wicket' ? { how: meta.how, outPlayer: meta.outPlayer, fielder: meta.fielder || null, newBatsman: meta.newBatsman || null } : null,
    summary,
    timestamp: new Date().toISOString()
  };
}

/* apply ball to inning & stats */
function applyBall(inn, ballObj, opts={legal:true}){
  opts = opts || {};
  const legal = opts.legal === undefined ? true : opts.legal;
  // push record
  inn.ballsDetailed.push(ballObj);

  // handle event types
  if(ballObj.eventType === 'run'){
    inn.total = (inn.total || 0) + ballObj.runs;
    const bat = findBatsman(inn, ballObj.batsman);
    if(bat){ bat.runs = (bat.runs||0) + ballObj.runs; bat.balls = (bat.balls||0) + 1; if(ballObj.runs===4) bat.fours=(bat.fours||0)+1; if(ballObj.runs===6) bat.sixes=(bat.sixes||0)+1; }
    const bw = getOrCreateBowler(inn, ballObj.bowler); bw.runs = (bw.runs||0) + ballObj.runs;
  } else if(ballObj.eventType === 'extra'){
    inn.total = (inn.total || 0) + ballObj.runs;
    // increment extras
    if(!inn.extras) inn.extras = {wides:0,noballs:0,byes:0,legbyes:0,total:0};
    const eKey = ballObj.extraType === 'wide' ? 'wides' : (ballObj.extraType === 'noball' ? 'noballs' : (ballObj.extraType==='bye'?'byes':'legbyes'));
    inn.extras[eKey] = (inn.extras[eKey]||0) + ballObj.runs;
    inn.extras.total = (inn.extras.total||0) + ballObj.runs;
    // if bye/legbye -> legal delivery: batsman gets ball but not runs
    if(ballObj.extraType === 'bye' || ballObj.extraType === 'legbye'){
      const bat = findBatsman(inn, ballObj.batsman); if(bat) bat.balls = (bat.balls||0) + 1;
      const bw = getOrCreateBowler(inn, ballObj.bowler); bw.runs = (bw.runs||0) + ballObj.runs;
    } else {
      // wide/noball -> bowler runs incremented already handled above (or here)
      const bw = getOrCreateBowler(inn, ballObj.bowler); bw.runs = (bw.runs||0) + ballObj.runs;
    }
  } else if(ballObj.eventType === 'wicket'){
    inn.wickets = (inn.wickets||0) + 1;
    const outName = ballObj.wicket.outPlayer;
    const b = findBatsman(inn, outName);
    if(b) b.status = `out (${ballObj.wicket.how}${ballObj.wicket.fielder? ', '+ballObj.wicket.fielder : ''})`;
    inn.fallOfWickets = inn.fallOfWickets || [];
    inn.fallOfWickets.push({ batsman: outName, score: inn.total || 0, wicket: inn.wickets, over: `${inn.overs}.${(inn.balls%6)+1}` });
    const bw = getOrCreateBowler(inn, ballObj.bowler); bw.wickets = (bw.wickets||0) + 1;
    if(ballObj.wicket.newBatsman){
      inn.battingOrder.push({ name: ballObj.wicket.newBatsman, runs:0, balls:0, fours:0, sixes:0, status:'not out' });
      matchJson.current.striker = ballObj.wicket.newBatsman;
    } else {
      matchJson.current.striker = null;
    }
  }

  // append current over display
  matchJson.current.currentOverBalls = matchJson.current.currentOverBalls || [];
  matchJson.current.currentOverBalls.push(ballObj.summary || (ballObj.eventType==='run'?ballObj.runs:ballObj.eventType));

  // handle legal delivery progression
  if(legal){
    // increment ball counters for inning
    inn.balls = (inn.balls || 0) + 1;
    // increment bowler ball count
    const bowlerName = ballObj.bowler;
    if(bowlerName){
      const bw = getOrCreateBowler(inn, bowlerName);
      bw.balls = (bw.balls||0) + 1;
      if(bw.balls >= 6){ bw.overs = (bw.overs||0) + 1; bw.balls = 0; }
    }
    // if ball completes over
    if(inn.balls >= 6){
      inn.overs = (inn.overs||0) + 1;
      // push over summary
      inn.oversSummary = inn.oversSummary || [];
      inn.oversSummary.push({ over: inn.overs, balls: (matchJson.current.currentOverBalls||[]).slice(), bowler: ballObj.bowler || matchJson.current.currentBowler || '' });
      // reset current over tracking
      matchJson.current.currentOverBalls = [];
      inn.balls = 0;
      swapStrikers();
    }
    // swap strike on odd runs (only for run events)
    if(ballObj.eventType === 'run' && (ballObj.runs % 2 === 1)){
      swapStrikers();
    }
    // freeHit handling: if it was free-hit, reset
    if(matchJson.current.isFreeHit){ matchJson.current.isFreeHit = false; freeHit = false; }
  } else {
    // non-legal (wide/noball) -> do not increment inn.balls
    // if noball enabled freeHit (already set when recorded)
  }

  // update matchJson.current fields
  matchJson.current.striker = $('strikerSelect').value;
  matchJson.current.nonStriker = $('nonStrikerSelect').value;
  matchJson.current.currentBowler = $('bowlerSelect').value;
  matchJson.lastSaved = new Date().toLocaleString();

  // recompute inning.over string for display (overs.balls)
  // (we keep inn.overs integer and inn.balls count for partial over)
  // render
  renderAll();
}

/* find batsman in battingOrder */
function findBatsman(inn, name){
  if(!name) return null;
  return inn.battingOrder.find(p=>p.name === name) || null;
}
function getOrCreateBowler(inn, name){
  if(!name) return null;
  let b = inn.bowlers.find(x=>x.name === name);
  if(!b){ b = { name, overs:0, balls:0, runs:0, wickets:0 }; inn.bowlers.push(b); }
  return b;
}

/* swap striker/non-striker */
function swapStrikers(){
  const tmp = matchJson.current.striker;
  matchJson.current.striker = matchJson.current.nonStriker;
  matchJson.current.nonStriker = tmp;
}

/* convenience to get current inning object */
function currentInning(){
  const idx = Number($('inningSelect').value || matchJson.currentInnings || 0);
  return matchJson.innings[idx];
}

/* ensure matchJson exists */
function ensureState(){ if(!matchJson) matchJson = createSkeleton(); }

/* after event: auto push logic */
async function afterEventAutoPush(){
  const autoPush = $('autoPushSelect').value === '1';
  const creds = getCreds();
  if(autoPush && creds.user && creds.token){
    try{
      await pushAllToGitHub(creds.user, creds.token);
      status('Auto-pushed to GitHub ‚úÖ', true);
    }catch(e){
      status('Auto-push failed: ' + (e.message||e), false);
      console.error(e);
    }
  } else {
    status('Event recorded locally. Enable Auto-push or press Save & Push.', true);
  }
}

/* ================== PUSH TO GITHUB ================== */

/* GET file sha (or null) */
async function getFileSha(user, repo, path, token){
  const api = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
  const res = await fetch(api, { headers: token ? { Authorization: 'token ' + token } : {} });
  if(res.status === 200){ const j = await res.json(); return j.sha; }
  if(res.status === 404) return null;
  const txt = await res.text(); throw new Error('GET file failed: ' + txt);
}

/* PUT file */
async function putFile(user, repo, path, content, message, token, sha=null){
  const api = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
  const body = { message, content: btoa(unescape(encodeURIComponent(content))) };
  if(sha) body.sha = sha;
  const res = await fetch(api, {
    method: 'PUT',
    headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  const j = await res.json();
  if(!res.ok) throw new Error(j.message || 'PUT failed');
  return j;
}

/* build lightweight live.json from matchJson */
function buildLiveJson(){
  const idx = Number($('inningSelect').value || matchJson.currentInnings || 0);
  const inn = matchJson.innings[idx];
  return {
    match: matchJson.title || matchJson.match,
    venue: matchJson.venue || '',
    status: matchJson.status || 'LIVE',
    toss: matchJson.toss || '',
    currentInnings: idx,
    innings: matchJson.innings.map(i=>({
      team: i.team,
      runs: i.total || 0,
      wickets: i.wickets || 0,
      overs: `${i.overs}.${i.balls||0}`,
      batsmen: (i.battingOrder||[]).slice(0,11).map(p=>({name:p.name,runs:p.runs||0,balls:p.balls||0,status:p.status||'not out'})),
      bowlers: (i.bowlers||[]).map(b=>({name:b.name,overs: (b.overs||0) + (b.balls?'.'+b.balls:''), runs:b.runs||0, wickets:b.wickets||0})),
      extras: i.extras || {total:0,wides:0,noballs:0,byes:0,legbyes:0},
      balls: i.ballsDetailed || [],
      fallOfWickets: i.fallOfWickets || []
    })),
    target: matchJson.matchMeta && matchJson.matchMeta.target ? matchJson.matchMeta.target : 0,
    runRate: calculateRunRate(matchJson.innings[idx]),
    lastUpdated: new Date().toLocaleString()
  };
}

function calculateRunRate(i){
  if(!i) return "0.00";
  const runs = i.total || 0;
  const overs = (i.overs||0) + ((i.balls||0)/6);
  if(!overs) return "0.00";
  return (runs/overs).toFixed(2);
}

/* push both match-1.json and live.json */
async function pushAllToGitHub(user, token){
  if(!user || !token) throw new Error('GitHub credentials missing');
  // prepare contents
  const matchContent = JSON.stringify(matchJson, null, 2);
  const liveContent = JSON.stringify(buildLiveJson(), null, 2);

  const matchPath = MATCH_PATH;
  const livePath = LIVE_PATH;

  // get shas
  let shaMatch = null, shaLive = null;
  try{ shaMatch = await getFileSha(user, REPO, matchPath, token); }catch(e){ console.warn('shaMatch err',e); }
  try{ shaLive = await getFileSha(user, REPO, livePath, token); }catch(e){ console.warn('shaLive err',e); }

  // put files (create or update)
  await putFile(user, REPO, matchPath, matchContent, `KPL: update ${matchPath}`, token, shaMatch);
  await putFile(user, REPO, livePath, liveContent, `KPL: update ${livePath}`, token, shaLive);

  matchJson.lastSaved = new Date().toLocaleString();
  renderAll();
  return true;
}

/* manual push button */
async function pushToGitHub(){
  let user = localStorage.getItem('kpl_gh_user') || '';
  let token = localStorage.getItem('kpl_gh_token') || '';
  if(!user) user = prompt('GitHub username (owner of repo):') || '';
  if(!token) token = prompt('GitHub Personal Access Token (ghp_...):') || '';
  if(!user || !token) return alert('username + token required');
  saveCreds(user, token);
  try{
    $('statusMsg').innerText = 'Pushing to GitHub...';
    await pushAllToGitHub(user, token);
    status('Saved to GitHub ‚úÖ', true);
  }catch(e){
    status('Push failed: ' + (e.message||e), false);
    console.error(e);
  }
}

/* ================== PREVIEW / DOWNLOAD ================== */
function previewLocal(){
  const blob = new Blob([JSON.stringify(matchJson, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'match-1.json'; a.click(); URL.revokeObjectURL(url);
}

/* reset skeleton local */
function toggleResetToSkeleton(){
  if(!confirm('Reset local match to skeleton/dummy players? Local only; not pushed unless you push.')) return;
  matchJson = createSkeleton();
  normalize();
  renderAll();
  status('Local skeleton loaded. Press Save & Push to send to GitHub.', true);
}

/* ================== BIND UI ================== */
$('inningSelect').addEventListener('change', ()=> renderAll());
$('strikerSelect').addEventListener('change', ()=> matchJson.current.striker = $('strikerSelect').value );
$('nonStrikerSelect').addEventListener('change', ()=> matchJson.current.nonStriker = $('nonStrikerSelect').value );
$('bowlerSelect').addEventListener('change', ()=> matchJson.current.currentBowler = $('bowlerSelect').value );

/* ================== INIT ================== */
(async function init(){
  // nothing until unlock; but supply helpful console message
  console.log('KPL advanced scorer ready. Unlock with PIN to start.');
})();
</script>
</body>
</html>
