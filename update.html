<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KPL Score Update Panel</title>
<style>
  body {
    background: #0b1120;
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
  }
  .hidden { display: none; }
  h1 {
    text-align: center;
    color: #38bdf8;
  }
  .card {
    background: #1e293b;
    padding: 20px;
    border-radius: 10px;
    max-width: 800px;
    margin: 20px auto;
    box-shadow: 0 0 10px #0005;
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  input, select, button {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: none;
    border-radius: 6px;
    font-size: 15px;
  }
  button {
    background: #38bdf8;
    color: #000;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover {
    background: #0ea5e9;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border-bottom: 1px solid #334155;
    padding: 6px;
  }
  pre {
    background: #0005;
    padding: 10px;
    border-radius: 10px;
    font-size: 13px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h1>üèè KPL Admin Score Updater</h1>

<div id="pinCard" class="card">
  <label>Enter Admin PIN</label>
  <input type="password" id="pinInput" placeholder="Enter PIN">
  <button onclick="checkPIN()">Login</button>
</div>

<div id="adminPanel" class="hidden">
  <div class="card">
    <label>Select Batting Team</label>
    <select id="battingTeam"></select>

    <label>Striker</label>
    <select id="striker"></select>

    <label>Non-Striker</label>
    <select id="nonStriker"></select>

    <label>Bowler</label>
    <select id="bowler"></select>

    <label>Ball Type</label>
    <select id="ballType">
      <option value="normal">Normal</option>
      <option value="wide">Wide</option>
      <option value="noball">No Ball</option>
      <option value="bye">Bye</option>
      <option value="legbye">Leg Bye</option>
      <option value="wicket">Wicket</option>
    </select>

    <label>Runs Scored</label>
    <input type="number" id="runs" min="0" max="6" value="0">

    <button onclick="recordBall()">Record Ball</button>
    <button onclick="saveToFile()">üíæ Save to live.json</button>
  </div>

  <div class="card">
    <h3>Over Summary</h3>
    <div id="overSummary">No balls yet.</div>

    <h3>Live JSON Preview</h3>
    <pre id="jsonPreview"></pre>
  </div>
</div>

<script>
const PIN = "4278";
let matchData = {};
let currentInnings = 0;

async function loadData() {
  const res = await fetch('data/live.json?' + new Date().getTime());
  matchData = await res.json();
  populateDropdowns();
  updatePreview();
}

function populateDropdowns() {
  const battingTeam = document.getElementById("battingTeam");
  const striker = document.getElementById("striker");
  const nonStriker = document.getElementById("nonStriker");
  const bowler = document.getElementById("bowler");

  battingTeam.innerHTML = "";
  striker.innerHTML = "";
  nonStriker.innerHTML = "";
  bowler.innerHTML = "";

  matchData.innings.forEach((inn, i) => {
    battingTeam.innerHTML += `<option value="${i}">${inn.team}</option>`;
  });

  const team = matchData.innings[currentInnings];
  team.batsmen.forEach(b => {
    striker.innerHTML += `<option value="${b.name}">${b.name}</option>`;
    nonStriker.innerHTML += `<option value="${b.name}">${b.name}</option>`;
  });

  team.bowlers.forEach(b => {
    bowler.innerHTML += `<option value="${b.name}">${b.name}</option>`;
  });
}

function checkPIN() {
  const pin = document.getElementById("pinInput").value;
  if (pin === PIN) {
    document.getElementById("pinCard").classList.add("hidden");
    document.getElementById("adminPanel").classList.remove("hidden");
    loadData();
  } else {
    alert("Incorrect PIN");
  }
}

function recordBall() {
  const ballType = document.getElementById("ballType").value;
  const runs = parseInt(document.getElementById("runs").value);
  const strikerName = document.getElementById("striker").value;
  const bowlerName = document.getElementById("bowler").value;
  const inn = matchData.innings[currentInnings];

  // Update batsman
  const batsman = inn.batsmen.find(b => b.name === strikerName);
  const bowler = inn.bowlers.find(b => b.name === bowlerName);
  let legalBall = true;
  let displayBall = runs;

  if (ballType === "wide" || ballType === "noball") {
    inn.runs += runs + 1;
    bowler.runs += runs + 1;
    displayBall = ballType === "wide" ? "Wd" : "Nb";
    legalBall = false;
  } else if (ballType === "bye" || ballType === "legbye") {
    inn.runs += runs;
    bowler.runs += runs;
    displayBall = ballType === "bye" ? "B" + runs : "LB" + runs;
  } else if (ballType === "wicket") {
    inn.wickets++;
    bowler.wickets++;
    displayBall = "W";
  } else {
    inn.runs += runs;
    batsman.runs += runs;
    batsman.balls++;
    bowler.runs += runs;
  }

  if (legalBall) {
    bowler.overs = (bowler.overs * 10 + 1) / 10; // increment ball
    if (bowler.overs % 1 >= 0.6) bowler.overs = Math.floor(bowler.overs) + 1;
    inn.overs = (inn.overs * 10 + 1) / 10;
    if (inn.overs % 1 >= 0.6) inn.overs = Math.floor(inn.overs) + 1;
  }

  inn.balls.push(displayBall);
  matchData.runRate = (inn.runs / (Math.floor(inn.overs) + (inn.overs % 1) * 10 / 6)).toFixed(2);
  matchData.lastUpdated = new Date().toLocaleTimeString();

  updatePreview();
}

function updatePreview() {
  document.getElementById("jsonPreview").textContent = JSON.stringify(matchData, null, 2);
  document.getElementById("overSummary").innerHTML = matchData.innings[currentInnings].balls.slice(-6).join(" ");
}

function saveToFile() {
  const blob = new Blob([JSON.stringify(matchData, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "live.json";
  a.click();
  URL.revokeObjectURL(url);
  alert("‚úÖ live.json downloaded ‚Äî upload to /data/ folder in GitHub");
}
</script>
</body>
</html>
